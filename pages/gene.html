---
permalink: /gene/
title: Gene Info
layout: base
---

<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css"
  crossorigin="anonymous"
/>
<link rel="stylesheet" type="text/css" href="/assets/css/violin.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/eqtlDashboard.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/tissueGroup.css" />

<style>
  .gene-expr-vplot-option-label {
    margin-left: 10px;
    margin-right: 5px;
  }
</style>

<div>
  <h3 id="gene-not-found"></h3>
</div>

<div id="gene-info">
  <h3 id="gene-title"></h3>
  <p id="gene-description"></p>

  <p>
    <a id="phenogen-link" target="_blank" href="">
      <button class="btn btn-primary">View in PhenoGen</button>
    </a>
  </p>

  <h5>Gene expression &amp; eQTL status per tissue</h5>
  <span id="gene-status"></span>

  <hr class="my-4" />

  <h5>Expression per tissue</h5>
  <p>
    <em>
      If the gene is expressed in very few samples in a tissue, it may not be
      plotted below.
    </em>
  </p>
  <div id="gene-expr-vplot" style="max-width: 800px"></div>

  <hr class="my-4" />

  <p>
    <a id="gev-link" href="">
      <button class="btn btn-primary">Visualize cis-eQTLs</button>
    </a>
  </p>

  <hr class="my-4" />

  <h5>cis-eQTLs</h5>
  <p>
    <em>
      Conditionally independent per tissue. Top eSNP shown per eQTL, randomly
      chosen among the top eSNPs in case of ties.
    </em>
  </p>
  <table id="eqtl-table"></table>

  <hr class="my-4" />

  <h5>All significant cis-window eSNPs</h5>
  <table id="eqtl-all-table"></table>

  <hr class="my-4" />

  <h5>cis-xQTLs</h5>
  <p>
    <em>
      Conditionally independent across modalities per tissue. Top SNP shown per
      xQTL, randomly chosen among the top SNPs in case of ties.
    </em>
  </p>
  <table id="xqtl-table"></table>

  <br />
</div>

<script src="https://cdn.jsdelivr.net/npm/file-saver@1.3.3/FileSaver.min.js"></script>
<script
  src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"
  crossorigin="anonymous"
></script>
<script src="/assets/js/gene-expression-violin-plot.bundle.min.js"></script>

<script>
  const sigDigitColumns = new Set(["pValueBeta", "log2aFC", "pValue", "nes"]);
  const scientificNotationColumns = new Set(["pValueBeta", "pValue"]);

  function formatSignificantDigits(value, useScientific) {
    if (value === null || value === undefined || value === "") {
      return value;
    }
    var num = Number(value);
    if (!Number.isFinite(num)) {
      return value;
    }
    if (useScientific) {
      return num.toExponential(2);
    }
    return num.toPrecision(3);
  }

  function formatCellValue(column, value) {
    if (sigDigitColumns.has(column)) {
      return formatSignificantDigits(
        value,
        scientificNotationColumns.has(column)
      );
    }
    return value;
  }

  function loadGene(info) {
    $("#gene-title").html(`Gene: <i>${info.geneId}</i>`);
    var desc = `${info.description}<br>${info.chromosome}:${info.start}-${info.end} (${info.strand})`;
    $("#gene-description").html(desc);
    $("#gev-link").attr("href", "/gene-eqtl-visualizer/#" + info.geneId);
    $("#phenogen-link").attr(
      "href",
      "https://phenogen.org/gene.jsp?speciesCB=Rn&auto=Y&geneTxt=" + info.geneId
    );
    info.statusInTissue.forEach(function (tissue) {
      var status = `<p><strong>${tissue.tissueSiteDetailId}:</strong>`;
      if (tissue.expressed) {
        status += ' <span class="badge bg-primary">Expressed</span>';
        if (tissue.testedEqtl) {
          status += ' <span class="badge bg-info">Tested for cis-eQTLs</span>';
          if (tissue.eqtl) {
            status +=
              ' <span class="badge bg-success">At least one cis-eQTL</span>';
          } else {
            status +=
              ' <span class="badge bg-secondary">No significant cis-eQTLs</span>';
          }
        } else {
          status +=
            ' <span class="badge bg-secondary">Not tested for cis-eQTLs</span>';
        }
      } else {
        status += ' <span class="badge bg-secondary">Not expressed</span>';
      }
      status += `</p>`;
      $("#gene-status").append(status);
    });

    GeneExpressionViolinPlot.launch(
      "gene-expr-vplot",
      "gene-expr-vplot-tooltip",
      info.geneId
    );

    $.ajax({
      dataType: "json",
      url: `/api/v4/eqtl?geneId=${info.geneId}`,
      success: function (data) {
        $("#eqtl-table").append(
          "<thead><tr><th>Tissue</th><th>Representative Variant ID</th><th>Ref</th><th>Alt</th><th>Adjusted P-Value</th><th>log<sub>2</sub>aFC</th></tr></thead><tbody>"
        );
        var cols = [
          "tissueSiteDetailId",
          "variantId",
          "ref",
          "alt",
          "pValueBeta",
          "log2aFC",
        ];
        $(data["eqtl"]).each(function (i, rowData) {
          var row = $("<tr></tr>");
          $(cols).each(function (j, col) {
            var displayValue = formatCellValue(col, rowData[col]);
            row.append($(`<td>${displayValue}</td>`));
          });
          $("#eqtl-table").append(row);
        });
        $("#eqtl-table").append("</tbody>");
        $("#eqtl-table").DataTable({
          order: [[4, "asc"]], // sort by p-value
        });
      },
    });

    $.ajax({
      dataType: "json",
      url: `/api/v4/singleTissueEqtl?geneId=${info.geneId}`,
      success: function (data) {
        $("#eqtl-all-table").append(
          "<thead><tr><th>Tissue</th><th>Variant ID</th><th>Nominal P-Value</th><th>Norm. Effect Size</th></tr></thead><tbody>"
        );
        var cols = ["tissueSiteDetailId", "variantId", "pValue", "nes"];
        $(data["singleTissueEqtl"]).each(function (i, rowData) {
          var row = $("<tr></tr>");
          $(cols).each(function (j, col) {
            var displayValue = formatCellValue(col, rowData[col]);
            row.append($(`<td>${displayValue}</td>`));
          });
          $("#eqtl-all-table").append(row);
        });
        $("#eqtl-all-table").append("</tbody>");
        $("#eqtl-all-table").DataTable({
          order: [[2, "asc"]], // sort by p-value
        });
      },
    });

    $.ajax({
      dataType: "json",
      url: `/api/v4/xqtl?geneId=${info.geneId}`,
      success: function (data) {
        $("#xqtl-table").append(
          "<thead><tr><th>Tissue</th><th>Modality</th><th>Phenotype ID</th><th>Representative Variant ID</th><th>Ref</th><th>Alt</th><th>Adjusted P-Value</th></tr></thead><tbody>"
        );
        var cols = [
          "tissueSiteDetailId",
          "modality",
          "phenotypeId",
          "variantId",
          "ref",
          "alt",
          "pValueBeta",
        ];
        $(data["xqtl"]).each(function (i, rowData) {
          var row = $("<tr></tr>");
          $(cols).each(function (j, col) {
            var displayValue = formatCellValue(col, rowData[col]);
            row.append($(`<td>${displayValue}</td>`));
          });
          $("#xqtl-table").append(row);
        });
        $("#xqtl-table").append("</tbody>");
        $("#xqtl-table").DataTable({
          order: [[5, "asc"]], // sort by p-value
        });
      },
    });
  }

  $(document).ready(function () {
    var gene = window.location.hash.slice(1); // slice removes hash
    $.ajax({
      dataType: "json",
      url: `/api/v4/gene?geneId=${gene}`,
      success: function (data) {
        if (data.gene.length == 0) {
          $("#gene-not-found").text(`Gene not found: ${gene}`);
          $("#gene-info").hide();
        } else {
          loadGene(data.gene[0]);
        }
      },
    });
  });
</script>
